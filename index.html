<script>
  // === ВСТАВЬТЕ СЮДА СВОЙ URL ИЗ APPS SCRIPT ===
  const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec";

  // State
  let currentView = 'day';
  let currentDate = new Date();
  let currentMonth = new Date();
  let bookings = [];
  let clients = [];
  let selectedTime = null;
  let selectedService = null;
  let selectedDateForBooking = null;
  let currentAvatar = null;

  // DOM Elements
  const dayView = document.getElementById('dayView');
  const weekCalendarView = document.getElementById('weekCalendarView');
  const monthCalendarView = document.getElementById('monthCalendarView');
  const dayHeader = document.getElementById('dayHeader');
  const weekCalendarHeader = document.getElementById('weekCalendarHeader');
  const monthCalendarTitle = document.getElementById('monthCalendarTitle');
  const dayAppointments = document.getElementById('dayAppointments');
  const weekDaysGrid = document.getElementById('weekDaysGrid');
  const monthGrid = document.getElementById('monthGrid');
  const clientsView = document.getElementById('clientsView');
  const searchInput = document.getElementById('searchInput');
  const clientsList = document.getElementById('clientsList');
  const addBookingBtn = document.getElementById('addBookingBtn');
  const bookingModal = document.getElementById('bookingModal');
  const closeModal = document.getElementById('closeModal');
  const bookingForm = document.getElementById('bookingForm');
  const clientPhone = document.getElementById('clientPhone');
  const clientName = document.getElementById('clientName');
  const bookingDate = document.getElementById('bookingDate');
  const timeTags = document.getElementById('timeTags');
  const notification = document.getElementById('notification');
  const currentDateElement = document.getElementById('currentDate');
  const navItems = document.querySelectorAll('.nav-item');
  const prevMonthBtn = document.getElementById('prevMonthBtn');
  const nextMonthBtn = document.getElementById('nextMonthBtn');
  const avatarPreview = document.getElementById('avatarPreview');
  const avatarInput = document.getElementById('avatarInput');
  const cameraBtn = document.getElementById('cameraBtn');
  const galleryBtn = document.getElementById('galleryBtn');
  const selectClientBtn = document.getElementById('selectClientBtn');

  const timeSlotsCache = {};

  // === GOOGLE INTEGRATION ===
  async function loadFromGoogle(sheet) {
    const res = await fetch(`${GOOGLE_SCRIPT_URL}?sheet=${sheet}&action=list`);
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    return data;
  }

  async function saveToGoogle(sheet, data) {
    const res = await fetch(`${GOOGLE_SCRIPT_URL}?sheet=${sheet}&action=add`, {
      method: 'POST',
      body: JSON.stringify(data),
      headers: { 'Content-Type': 'application/json' }
    });
    const result = await res.json();
    if (result.error) throw new Error(result.error);
  }

  async function deleteFromGoogle(sheet, id) {
    const res = await fetch(`${GOOGLE_SCRIPT_URL}?sheet=${sheet}&action=delete&id=${id}`);
    const result = await res.json();
    if (result.error) throw new Error(result.error);
  }

  // === INIT ===
  async function init() {
    const today = new Date();
    currentDateElement.textContent = formatDisplayDate(today);
    updateDateInputs();
    
    try {
      clients = await loadFromGoogle('clients');
      bookings = await loadFromGoogle('bookings');
    } catch (e) {
      console.error("Ошибка загрузки данных:", e);
      showNotification("Ошибка загрузки данных");
      // Используем локальные данные как fallback
      initSampleData();
    }
    
    renderDayView();
    setupEventListeners();
  }

  // === HELPER FUNCTIONS (БЕЗ ИЗМЕНЕНИЙ) ===
  function formatDate(date) {
    const utc = date.getTime() + (date.getTimezoneOffset() * 60000);
    const localTime = new Date(utc + (3600000 * 5));
    return localTime.toISOString().split('T')[0];
  }

  function formatDisplayDate(date) {
    const utc = date.getTime() + (date.getTimezoneOffset() * 60000);
    const localTime = new Date(utc + (3600000 * 5));
    return localTime.toLocaleDateString('ru-RU', { 
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
    });
  }

  function formatMonthYear(date) {
    const utc = date.getTime() + (date.getTimezoneOffset() * 60000);
    const localTime = new Date(utc + (3600000 * 5));
    return localTime.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
  }

  function formatWeekRange(weekStart, weekEnd) {
    const utcStart = weekStart.getTime() + (weekStart.getTimezoneOffset() * 60000);
    const localStart = new Date(utcStart + (3600000 * 5));
    const utcEnd = weekEnd.getTime() + (weekEnd.getTimezoneOffset() * 60000);
    const localEnd = new Date(utcEnd + (3600000 * 5));
    return `Неделя: ${localStart.getDate()} - ${localEnd.getDate()} ${localStart.toLocaleDateString('ru-RU', { month: 'long' })} ${localStart.getFullYear()}`;
  }

  function getTimeSlots(dateStr) {
    if (timeSlotsCache[dateStr]) return timeSlotsCache[dateStr];
    const slots = [];
    for (let hour = 8; hour <= 19; hour++) {
      slots.push(`${hour.toString().padStart(2, '0')}:00`);
      slots.push(`${hour.toString().padStart(2, '0')}:30`);
    }
    slots.push('20:00');
    timeSlotsCache[dateStr] = slots;
    return slots;
  }

  function isTimeBooked(dateStr, time) {
    return bookings.some(b => b.date === dateStr && b.time === time);
  }

  function getClientById(clientId) {
    return clients.find(c => c.id == clientId);
  }

  function isWeekend(date) {
    const utc = date.getTime() + (date.getTimezoneOffset() * 60000);
    const localTime = new Date(utc + (3600000 * 5));
    const day = localTime.getDay();
    return day === 0 || day === 6;
  }

  function isPastAppointment(dateStr, timeStr) {
    const now = new Date();
    const appointmentDate = new Date(dateStr + 'T' + timeStr + ':00');
    const utc = appointmentDate.getTime() + (appointmentDate.getTimezoneOffset() * 60000);
    const localTime = new Date(utc + (3600000 * 5));
    return localTime < now;
  }

  function getWeekStart(date) {
    const start = new Date(date);
    const utc = start.getTime() + (start.getTimezoneOffset() * 60000);
    const localTime = new Date(utc + (3600000 * 5));
    const day = localTime.getDay();
    const diff = localTime.getDate() - day + (day === 0 ? -6 : 1);
    start.setDate(diff);
    return start;
  }

  // === RENDER FUNCTIONS (БЕЗ ИЗМЕНЕНИЙ) ===
  function renderTimeTags(dateStr) {
    timeTags.innerHTML = '';
    const timeSlots = getTimeSlots(dateStr);
    timeSlots.forEach(time => {
      const isBooked = isTimeBooked(dateStr, time);
      const tag = document.createElement('div');
      tag.className = `time-tag ${isBooked ? 'booked' : ''}`;
      tag.textContent = time;
      if (!isBooked) {
        tag.addEventListener('click', () => {
          document.querySelectorAll('.time-tag').forEach(t => t.classList.remove('selected'));
          tag.classList.add('selected');
          selectedTime = time;
        });
      }
      timeTags.appendChild(tag);
    });
  }

  function renderDayView() {
    dayHeader.textContent = formatDisplayDate(currentDate);
    const dateStr = formatDate(currentDate);
    const dayBookings = bookings.filter(b => b.date === dateStr);
    if (dayBookings.length === 0) {
      dayAppointments.innerHTML = '<div class="no-appointments">Нет записей на сегодня</div>';
      return;
    }
    dayBookings.sort((a, b) => a.time.localeCompare(b.time));
    dayAppointments.innerHTML = dayBookings.map(booking => {
      const client = getClientById(booking.clientId);
      const isPast = isPastAppointment(booking.date, booking.time);
      const pastClass = isPast ? 'past' : '';
      const showCancel = !isPast;
      return `
        <div class="appointment ${pastClass}">
          <div class="appointment-avatar">
            ${client && client.avatar ? `<img src="${client.avatar}" alt="${client.name}">` : '<i class="fas fa-user"></i>'}
          </div>
          <div class="appointment-info">
            <div class="appointment-time">${booking.time}</div>
            <div class="appointment-service">${booking.service} (${client ? client.name : 'Неизвестный'})</div>
          </div>
          ${showCancel ? `<button class="appointment-cancel" onclick="cancelBooking(${booking.id})">Отменить</button>` : ''}
        </div>
      `;
    }).join('');
  }

  function renderWeekCalendarView() {
    const weekStart = getWeekStart(currentDate);
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);
    weekCalendarHeader.textContent = formatWeekRange(weekStart, weekEnd);
    let html = '';
    for (let i = 0; i < 7; i++) {
      const day = new Date(weekStart);
      day.setDate(weekStart.getDate() + i);
      const dateStr = formatDate(day);
      const dayBookings = bookings.filter(b => b.date === dateStr);
      const isToday = day.toDateString() === new Date().toDateString();
      const dayName = day.toLocaleDateString('ru-RU', { weekday: 'short' });
      const dayDate = day.getDate();
      const dayClasses = ['week-day-cell'];
      if (isToday) dayClasses.push('today');
      if (dayBookings.length > 0) dayClasses.push('has-appointments');
      if (isWeekend(day)) dayClasses.push('saturday', 'sunday');
      html += `
        <div class="${dayClasses.join(' ')}" data-date="${dateStr}">
          <div class="week-day-name">${dayName}</div>
          <div class="week-day-date">${dayDate}</div>
        </div>
      `;
    }
    weekDaysGrid.innerHTML = html;
    document.querySelectorAll('.week-day-cell').forEach(el => {
      el.addEventListener('click', (e) => {
        const dateStr = e.currentTarget.dataset.date;
        selectedDateForBooking = new Date(dateStr);
        openBookingModal();
      });
    });
  }

  function renderMonthCalendarView() {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    monthCalendarTitle.textContent = formatMonthYear(currentMonth);
    const firstDay = new Date(year, month, 1);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    const daysHeader = [
      { day: 'Пн', class: '' },
      { day: 'Вт', class: '' },
      { day: 'Ср', class: '' },
      { day: 'Чт', class: '' },
      { day: 'Пт', class: '' },
      { day: 'Сб', class: 'saturday' },
      { day: 'Вс', class: 'sunday' }
    ];
    let html = daysHeader.map(item => 
      `<div class="month-day-header ${item.class}">${item.day}</div>`
    ).join('');
    
    const current = new Date(startDate);
    for (let i = 0; i < 42; i++) {
      const isCurrentMonth = current.getMonth() === month;
      const dateStr = formatDate(current);
      const dayBookings = bookings.filter(b => b.date === dateStr);
      const isToday = current.toDateString() === new Date().toDateString();
      const isWeekendDay = isWeekend(current);
      const dayClasses = ['month-day'];
      if (!isCurrentMonth) dayClasses.push('other-month');
      if (isToday) dayClasses.push('today');
      if (isWeekendDay) dayClasses.push('saturday', 'sunday');
      html += `<div class="${dayClasses.join(' ')}" data-date="${dateStr}">
        <div class="month-day-number">${current.getDate()}</div>
        <div class="month-day-appointments">`;
      const visible = dayBookings.slice(0, 3);
      visible.forEach(b => {
        const client = getClientById(b.clientId);
        const isPast = isPastAppointment(b.date, b.time);
        const pastClass = isPast ? 'past' : '';
        html += `<div class="month-appointment ${pastClass}" title="${b.time} - ${b.service} (${client ? client.name : 'Клиент'})">${b.time}</div>`;
      });
      if (dayBookings.length > 3) {
        html += `<div class="month-appointment" title="Еще ${dayBookings.length - 3} записей">+${dayBookings.length - 3}</div>`;
      }
      html += `</div></div>`;
      current.setDate(current.getDate() + 1);
    }
    monthGrid.innerHTML = html;
    document.querySelectorAll('.month-day').forEach(el => {
      if (!el.classList.contains('other-month')) {
        el.addEventListener('click', (e) => {
          const dateStr = e.currentTarget.dataset.date;
          selectedDateForBooking = new Date(dateStr);
          openBookingModal();
        });
      }
    });
  }

  function renderClientsList() {
    const term = searchInput.value.toLowerCase();
    const filtered = clients.filter(c => 
      c.name.toLowerCase().includes(term) || c.phone.toLowerCase().includes(term)
    );
    if (filtered.length === 0) {
      clientsList.innerHTML = '<div class="no-appointments">Клиенты не найдены</div>';
      return;
    }
    clientsList.innerHTML = filtered.map(client => `
      <div class="client-card" data-client-id="${client.id}">
        <div class="client-avatar">
          ${client.avatar ? `<img src="${client.avatar}" alt="${client.name}">` : '<i class="fas fa-user"></i>'}
        </div>
        <div class="client-info">
          <div class="client-name">${client.name}</div>
          <div class="client-phone">${client.phone}</div>
        </div>
      </div>
    `).join('');
    
    document.querySelectorAll('.client-card').forEach(card => {
      card.addEventListener('click', () => {
        const id = parseInt(card.dataset.clientId);
        const client = clients.find(c => c.id == id);
        if (client) {
          clientName.value = client.name;
          clientPhone.value = client.phone;
          avatarPreview.innerHTML = client.avatar ? `<img src="${client.avatar}">` : '<i class="fas fa-user"></i>';
          bookingModal.style.display = 'flex';
          clientsView.style.display = 'none';
          navItems.forEach(i => i.classList.remove('active'));
          document.querySelector('.nav-item[data-tab="home"]').classList.add('active');
          updateDateInputs();
          renderTimeTags(bookingDate.value);
        }
      });
    });
  }

  async function cancelBooking(id) {
    if (confirm('Отменить запись?')) {
      try {
        await deleteFromGoogle('bookings', id);
        bookings = bookings.filter(b => b.id != id);
        showNotification('Запись отменена!');
        renderCurrentView();
      } catch (e) {
        alert("Ошибка: " + e.message);
      }
    }
  }

  function renderCurrentView() {
    if (currentView === 'day') {
      dayView.style.display = 'block';
      weekCalendarView.style.display = 'none';
      monthCalendarView.style.display = 'none';
      renderDayView();
    } else if (currentView === 'week') {
      dayView.style.display = 'none';
      weekCalendarView.style.display = 'block';
      monthCalendarView.style.display = 'none';
      renderWeekCalendarView();
    } else if (currentView === 'month') {
      dayView.style.display = 'none';
      weekCalendarView.style.display = 'none';
      monthCalendarView.style.display = 'block';
      renderMonthCalendarView();
    }
  }

  function showTab(tab) {
    navItems.forEach(i => i.classList.remove('active'));
    document.querySelector(`.nav-item[data-tab="${tab}"]`).classList.add('active');
    if (tab === 'home') {
      clientsView.style.display = 'none';
      renderCurrentView();
    } else if (tab === 'clients') {
      clientsView.style.display = 'block';
      dayView.style.display = 'none';
      weekCalendarView.style.display = 'none';
      monthCalendarView.style.display = 'none';
      renderClientsList();
    }
  }

  function showView(view) {
    currentView = view;
    document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.view-btn[data-view="${view}"]`).classList.add('active');
    renderCurrentView();
  }

  function setupEventListeners() {
    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.addEventListener('click', () => showView(btn.dataset.view));
    });
    navItems.forEach(item => {
      item.addEventListener('click', () => showTab(item.dataset.tab));
    });
    prevMonthBtn.addEventListener('click', () => {
      currentMonth.setMonth(currentMonth.getMonth() - 1);
      renderMonthCalendarView();
    });
    nextMonthBtn.addEventListener('click', () => {
      currentMonth.setMonth(currentMonth.getMonth() + 1);
      renderMonthCalendarView();
    });
    addBookingBtn.addEventListener('click', () => {
      selectedDateForBooking = new Date();
      openBookingModal();
    });
    closeModal.addEventListener('click', closeBookingModal);
    bookingForm.addEventListener('submit', handleBookingSubmit);
    bookingModal.addEventListener('click', (e) => {
      if (e.target === bookingModal) closeBookingModal();
    });
    let searchTimeout;
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(renderClientsList, 300);
    });
    galleryBtn.addEventListener('click', () => avatarInput.click());
    cameraBtn.addEventListener('click', () => {
      avatarInput.setAttribute('capture', 'environment');
      avatarInput.click();
      avatarInput.removeAttribute('capture');
    });
    avatarInput.addEventListener('change', (e) => {
      if (e.target.files && e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = (event) => {
          currentAvatar = event.target.result;
          avatarPreview.innerHTML = `<img src="${currentAvatar}">`;
        };
        reader.readAsDataURL(e.target.files[0]);
      }
    });
    selectClientBtn.addEventListener('click', () => {
      bookingModal.style.display = 'none';
      showTab('clients');
      setTimeout(() => {
        document.querySelectorAll('.client-card').forEach(card => {
          card.addEventListener('click', () => {
            const id = parseInt(card.dataset.clientId);
            const client = clients.find(c => c.id == id);
            if (client) {
              clientName.value = client.name;
              clientPhone.value = client.phone;
              avatarPreview.innerHTML = client.avatar ? `<img src="${client.avatar}">` : '<i class="fas fa-user"></i>';
              bookingModal.style.display = 'flex';
              clientsView.style.display = 'none';
              navItems.forEach(i => i.classList.remove('active'));
              document.querySelector('.nav-item[data-tab="home"]').classList.add('active');
              updateDateInputs();
              renderTimeTags(bookingDate.value);
            }
          });
        });
      }, 100);
    });
    bookingDate.addEventListener('change', () => renderTimeTags(bookingDate.value));
  }

  function updateDateInputs() {
    const today = new Date();
    bookingDate.min = today.toISOString().split('T')[0];
    if (selectedDateForBooking) {
      bookingDate.value = formatDate(selectedDateForBooking);
    } else {
      bookingDate.value = formatDate(today);
    }
  }

  function openBookingModal() {
    bookingModal.style.display = 'flex';
    selectedTime = null;
    selectedService = null;
    currentAvatar = null;
    updateDateInputs();
    renderTimeTags(bookingDate.value);
    avatarPreview.innerHTML = '<i class="fas fa-user"></i>';
    clientName.value = '';
    clientPhone.value = '';
    document.querySelectorAll('.service-tag').forEach(t => t.classList.remove('selected'));
  }

  function closeBookingModal() {
    bookingModal.style.display = 'none';
    bookingForm.reset();
    selectedTime = null;
    selectedService = null;
    selectedDateForBooking = null;
    currentAvatar = null;
  }

  async function handleBookingSubmit(e) {
    e.preventDefault();
    const serviceTags = document.querySelectorAll('.service-tag');
    let service = null;
    serviceTags.forEach(tag => {
      if (tag.classList.contains('selected')) {
        service = tag.dataset.service;
      }
    });
    if (!selectedTime || !service) {
      alert('Выберите время и услугу');
      return;
    }

    let client = clients.find(c => c.phone === clientPhone.value);
    if (!client) {
      const newClient = {
        id: Date.now(),
        name: clientName.value,
        phone: clientPhone.value,
        avatar: currentAvatar || ''
      };
      await saveToGoogle('clients', newClient);
      clients.push(newClient);
      client = newClient;
    }

    const newBooking = {
      id: Date.now(),
      clientId: client.id,
      date: bookingDate.value,
      time: selectedTime,
      service: service
    };
    await saveToGoogle('bookings', newBooking);
    bookings.push(newBooking);

    showNotification('Клиент записан!');
    closeBookingModal();
    renderCurrentView();
  }

  function showNotification(message) {
    document.querySelector('.notification span').textContent = message;
    notification.classList.add('show');
    setTimeout(() => notification.classList.remove('show'), 3000);
  }

  clientPhone.addEventListener('input', function(e) {
    let v = e.target.value.replace(/\D/g, '');
    if (v.length > 11) v = v.substring(0, 11);
    if (v.length > 0) {
      v = '+7 (' + v.substring(1, 4) + ') ' + v.substring(4, 7) + '-' + v.substring(7, 9) + '-' + v.substring(9, 11);
    }
    e.target.value = v;
  });

  // Fallback data (for offline or error cases)
  function initSampleData() {
    clients = [
      { id: 1, name: 'Анна Петрова', phone: '+7 (999) 123-45-67', avatar: null },
      { id: 2, name: 'Михаил Соколов', phone: '+7 (999) 234-56-78', avatar: null },
      { id: 3, name: 'Елена Кузнецова', phone: '+7 (999) 345-67-89', avatar: null }
    ];
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    bookings = [
      { id: 1, clientId: 1, date: formatDate(today), time: '09:00', service: 'Стрижка' },
      { id: 2, clientId: 2, date: formatDate(today), time: '10:30', service: 'Покраска' },
      { id: 3, clientId: 3, date: formatDate(tomorrow), time: '14:00', service: 'Прическа' }
    ];
  }

  // Start app
  init();
</script>
